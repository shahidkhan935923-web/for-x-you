<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hobby Lite - Rewarded PiP Ad</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Mobile App Look & Neon Glow */
        :root {
            --neon-yellow: 255, 230, 0;
            --neon-blue: 0, 162, 255;
            --neon-red: 255, 0, 85;
            --neon-green: 0, 255, 127;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: white;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        /* Main Phone Frame Container */
        #phone-frame {
            width: 100%;
            max-width: 450px; /* Max width for mobile view */
            height: 100vh; /* Full viewport height */
            position: relative;
            background: #101010;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }

        /* Video Layer (Covers most of the screen) */
        #video-layer {
            flex-grow: 1;
            position: relative;
        }

        #main-video-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Action Buttons (Right side - Heart, Share, Spark) */
        #action-buttons {
            position: absolute;
            right: 0.75rem;
            bottom: 30%; 
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 10;
        }

        .action-icon {
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
        }

        /* PiP Ad Container (Hidden by default, shown when rewarded is ready) */
        #ad-video-container {
            position: absolute;
            bottom: 6rem; /* User info se thoda upar */
            right: 4.5rem; /* Action buttons se dur */
            width: 160px; /* Small size for PiP */
            height: 90px; /* 16:9 aspect ratio */
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(var(--neon-green), 0.7);
            border: 2px solid rgba(var(--neon-green), 0.9);
            z-index: 50;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        
        /* Spark Button and Text (Bottom Overlay) */
        #user-info-overlay {
            position: absolute;
            bottom: 4rem; /* Footer se upar */
            left: 0;
            right: 0;
            padding: 0 1rem 0.5rem 1rem;
            z-index: 20;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0));
        }

        .spark-button {
            transition: all 0.3s ease-in-out;
            cursor: not-allowed;
            filter: grayscale(100%);
            pointer-events: none;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        
        .spark-button.ready {
            cursor: pointer;
            filter: grayscale(0%);
            pointer-events: auto;
            background-color: #10b981; /* Green-500 */
            box-shadow: 0 0 15px rgba(var(--neon-green), 0.8);
            animation: pulse-green 1.5s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 10px rgba(var(--neon-green), 0.8), 0 0 5px rgba(var(--neon-green), 0.4); }
            50% { box-shadow: 0 0 20px rgba(var(--neon-green), 1), 0 0 10px rgba(var(--neon-green), 0.6); }
        }

        /* Loading Indicator */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #fff;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 1000;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="phone-frame">
        
        <!-- Header (Top Bar) -->
        <header class="h-10 flex items-center px-4 bg-black z-30">
            <span class="text-xl font-semibold text-yellow-400">‚Üê For X You</span>
        </header>

        <!-- Video Layer -->
        <div id="video-layer">
            
            <!-- Main Video Player -->
            <div id="main-video-container">
                <iframe id="main-youtube-frame" class="w-full h-full" 
                        src="" 
                        frameborder="0" 
                        allow="autoplay; encrypted-media; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>

            <!-- Action Buttons (Right side) -->
            <div id="action-buttons">
                <!-- Heart Icon -->
                <div class="action-icon text-3xl text-white drop-shadow-lg" style="filter: drop-shadow(0 0 5px rgba(var(--neon-blue), 0.8));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                </div>
                <!-- Comment Icon -->
                <div class="action-icon text-3xl text-white drop-shadow-lg" style="filter: drop-shadow(0 0 5px rgba(var(--neon-blue), 0.8));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
                <!-- Spark Icon (Will be replaced by PiP box when rewarded) -->
                <div id="spark-button-icon" class="action-icon text-3xl text-white drop-shadow-lg" style="filter: drop-shadow(0 0 5px rgba(var(--neon-yellow), 0.8));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.9 6.2c-1.5-.7-3.1-.9-4.7-.6-1.5.3-2.9 1.1-3.9 2.4-1 1.3-1.6 2.8-1.7 4.5-.1 1.7.3 3.4 1.2 4.9.9 1.5 2.2 2.7 3.8 3.5 1.6.8 3.3 1.1 5.1.8 1.8-.3 3.4-1.2 4.7-2.5 1.2-1.3 1.9-2.8 2-4.5.1-1.7-.3-3.4-1.2-4.9-1-1.5-2.2-2.7-3.8-3.5-1.6-.8-3.3-1.1-5.1-.8l-1.5.3"/></svg>
                </div>
            </div>

            <!-- PiP Ad Video Container -->
            <div id="ad-video-container" class="hidden">
                <iframe id="ad-youtube-frame" class="w-full h-full"
                        src=""
                        frameborder="0"
                        allow="autoplay; encrypted-media; picture-in-picture"
                        allowfullscreen>
                </iframe>
            </div>

             <!-- User Info and Spark Button Overlay -->
            <div id="user-info-overlay" class="space-y-3">
                 <!-- User/Music Info -->
                <div>
                    <div class="font-bold text-lg">@GrooveMaster47</div>
                    <div class="text-sm">Breaking it down with some new moves!</div>
                    <div class="text-xs text-gray-400 flex items-center space-x-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
                        <span>#1 Neon Beats - ElectroFunk Mix</span>
                    </div>
                </div>

                <!-- Spark Button (Rewarded Action) -->
                <button id="spark-button" 
                        class="spark-button w-full h-10 bg-red-600 text-white font-bold rounded-lg flex items-center justify-center space-x-2 shadow-lg transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.9 6.2c-1.5-.7-3.1-.9-4.7-.6-1.5.3-2.9 1.1-3.9 2.4-1 1.3-1.6 2.8-1.7 4.5-.1 1.7.3 3.4 1.2 4.9.9 1.5 2.2 2.7 3.8 3.5 1.6.8 3.3 1.1 5.1.8 1.8-.3 3.4-1.2 4.7-2.5 1.2-1.3 1.9-2.8 2-4.5.1-1.7-.3-3.4-1.2-4.9-1-1.5-2.2-2.7-3.8-3.5-1.6-.8-3.3-1.1-5.1-.8l-1.5.3"/></svg>
                    <span id="spark-text">0s / 5s - Ad Dekhiye</span>
                </button>
            </div>
            
        </div>

        <!-- Footer (Bottom Navigation) -->
        <footer class="h-16 bg-black border-t border-gray-800 flex justify-around items-center z-30">
            <button class="text-yellow-400 flex flex-col items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs">Home</span>
            </button>
            <button class="text-gray-400 hover:text-white flex flex-col items-center transition duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V4"/><path d="M16 4h2a2 2 0 0 1 2 2v14"/><path d="M8 4H6a2 2 0 0 0-2 2v14"/></svg>
                <span class="text-xs">Rewards</span>
            </button>
            <button class="text-gray-400 hover:text-white flex flex-col items-center transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"/></svg>
                <span class="text-xs">Create</span>
            </button>
            <button class="text-gray-400 hover:text-white flex flex-col items-center transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-xs">Profile</span>
            </button>
        </footer>
        
         <!-- Loading Indicator (Outside phone-frame so it centers on the full canvas) -->
        <div id="loading-indicator" class="text-xl text-yellow-400">
            ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...
        </div>
    </div>


    <!-- Firebase SDKs ‡§î‡§∞ JavaScript ‡§≤‡•â‡§ú‡§ø‡§ï -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. ‡§´‡§æ‡§Ø‡§∞‡§¨‡•á‡§∏ ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® (‡§Ø‡§π ‡§ï‡•ã‡§° Canvas Environment ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ) ---
        // ‡§®‡•ã‡§ü: ‡§π‡§Æ ‡§Ü‡§™‡§ï‡•á ‡§™‡§ø‡§õ‡§≤‡•á Firebase ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ‡§ï‡•ã ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§
        
        const YOUR_APP_ID = "for-x-you-v1"; // ‡§Ü‡§™‡§ï‡•á ‡§ê‡§™ ‡§ï‡§æ ID
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCcQb2Bpmw6tIaFuzOZ7PGnx76-Th7MtBw",
            authDomain: "for-x-you.firebaseapp.com",
            projectId: "for-x-you",
            storageBucket: "for-x-you.appspot.com",
            messagingSenderId: "984407200677",
            appId: "1:984407200677:web:53ad51a3cf078019854e4c",
            measurementId: "G-ND2X9EBVL6"
        };
        const YOUR_INITIAL_AUTH_TOKEN = null;
        
        let db;
        let auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : YOUR_APP_ID;
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : YOUR_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : YOUR_INITIAL_AUTH_TOKEN;
        
        // UI Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const phoneFrame = document.getElementById('phone-frame');
        const sparkButton = document.getElementById('spark-button');
        const sparkText = document.getElementById('spark-text');
        const adVideoContainer = document.getElementById('ad-video-container');

        // YouTube Players (Global variables for the YouTube API)
        let mainPlayer;
        let adPlayer;
        let requiredWatchTime = 3; // Default value, will be updated by Firestore
        let adBodyText = "Voice Ad is ready!"; // Default
        
        // Timer Logic
        let watchTimer = null;
        let currentWatchTime = 0;
        let isAdSparked = false; // Check if user has already sparked this ad

        // TTS Audio Context
        let audioContext;
        let ttsData = null; // Store the fetched TTS data URL

        // --- YouTube Player API Initialization ---
        window.onYouTubeIframeAPIReady = function() {
            // Placeholder: Players will be created once Firestore data is loaded
        };

        // YouTube URL se Video ID nikalta hai
        function getEmbedId(url) {
            let videoId = null;
            if (url && url.length === 11 && !url.includes('/')) {
                videoId = url;
            } else if (url && url.includes('youtube.com/watch?v=')) {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                videoId = params.get('v');
            } else if (url && url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url && url.includes('/shorts/')) {
                videoId = url.split('/shorts/')[1].split('/')[0].split('?')[0];
            }
            // Agar videoId nahi mila to ek default ID use karein (Example Short)
            return videoId || '5s_DqJ83X5g';
        }

        // Players ko create aur initialize karne ka function
        function createPlayers(mainVideoId, adVideoId) {
            
            // Main Player (Autoplay ON, Mute ON)
            mainPlayer = new YT.Player('main-youtube-frame', {
                videoId: mainVideoId,
                playerVars: {
                    'autoplay': 1,      // Autoplay
                    'mute': 1,          // Mute shuru mein
                    'controls': 0,      // Controls chhupayein
                    'loop': 1,          // Loop on
                    'playlist': mainVideoId, // Loop ke liye zaroori
                    'enablejsapi': 1,
                    'modestbranding': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onMainPlayerReady
                }
            });

            // Ad Player (Autoplay ON, Mute ON) - Hidden by default
            adPlayer = new YT.Player('ad-youtube-frame', {
                videoId: adVideoId,
                playerVars: {
                    'autoplay': 1,
                    'mute': 1,          // Ad video bhi shuru mein mute rahega
                    'controls': 0,
                    'loop': 1,
                    'playlist': adVideoId,
                    'enablejsapi': 1,
                    'modestbranding': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onAdPlayerReady,
                    'onStateChange': onAdPlayerStateChange
                }
            });
        }

        function onMainPlayerReady(event) {
            console.log("Main Player Ready.");
        }

        function onAdPlayerReady(event) {
            console.log("Ad Player Ready. Starting Ad Timer.");
            // Ad player ready hote hi timer shuru karein
            startAdTimer();
        }
        
        function onAdPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING && !isAdSparked) {
                // Agar ad chal raha hai aur reward nahi mila hai, to timer shuru karein
                startAdTimer();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
                // Agar ad ruk jaye to timer rok dein
                clearInterval(watchTimer);
            }
        }

        // --- Ad Watch Timer Logic ---
        function startAdTimer() {
            if (isAdSparked) return; // Agar reward mil chuka hai to timer shuru nahi karna
            
            clearInterval(watchTimer);
            watchTimer = setInterval(() => {
                if (adPlayer && adPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                    currentWatchTime++;
                    sparkText.textContent = ${currentWatchTime}s / ${requiredWatchTime}s - Ad Dekhiye;

                    if (currentWatchTime >= requiredWatchTime) {
                        // Reward Condition met!
                        clearInterval(watchTimer);
                        sparkButton.classList.add('ready');
                        sparkText.textContent = Spark Ready! Reward lene ke liye click karein!;
                        adVideoContainer.classList.remove('hidden'); // PiP box dikhayein
                    }
                }
            }, 1000); // Har second check karein
        }
        
        // Spark Button Click Handler (Reward Action)
        sparkButton.addEventListener('click', async () => {
            if (sparkButton.classList.contains('ready') && !isAdSparked) {
                isAdSparked = true;
                
                // 1. Reward: Ad video ko chhupa dein
                adVideoContainer.classList.add('hidden');
                
                // 2. TTS Play karein
                sparkButton.classList.remove('ready');
                sparkButton.classList.remove('bg-red-600');
                sparkButton.classList.add('bg-green-700');
                sparkText.textContent = Spark Received! Dhanyawad!;

                if (ttsData) {
                    playTTS(ttsData);
                } else {
                    console.error("TTS data not available to play.");
                }
                
                // 3. Button ko dobara disable kar dein
                sparkButton.classList.remove('ready');
                sparkButton.classList.add('spark-button'); // Reset style to disable
            }
        });

        // --- TTS Audio Functions (Same as previous, for consistency) ---

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;
            function writeString(s) {
                for (let i = 0; i < s.length; i++) { view.setUint8(offset + i, s.charCodeAt(i)); } offset += s.length;
            }

            writeString('RIFF'); offset = 4;
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString('WAVE'); offset = 8;

            writeString('fmt '); offset = 12;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, 16, true); offset += 2;

            writeString('data'); offset = 36;
            view.setUint32(offset, dataSize, true); offset += 4;
            
            const pcmView = new DataView(pcm16.buffer);
            for (let i = 0; i < dataSize; i++) {
                view.setUint8(offset + i, pcmView.getUint8(i));
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        async function fetchTTS(text) {
             const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = "";
            const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey};

            try {
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                            const match = mimeType.match(/rate=(\d+)/);
                            const sampleRate = match ? parseInt(match[1], 10) : 16000;
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            return URL.createObjectURL(wavBlob);
                        } else {
                             console.error("TTS response error: Audio data not found or invalid MIME type.", mimeType, result);
                             return null;
                        }
                    } else if (response.status === 429 && i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue;
                    } else {
                        console.error(TTS API Error: ${response.status} ${response.statusText});
                        return null;
                    }
                }
            } catch (error) {
                console.error("TTS Fetch Failed:", error);
            }
            return null;
        }

        function playTTS(url) {
            if (audioContext && audioContext.state === 'running') {
                audioContext.close();
            }
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const audio = new Audio(url);
            audio.play().catch(error => {
                console.error("Audio playback failed (Requires user interaction):", error);
            });
        }
        
        // --- Firebase Initialization and Listener ---
        
        async function initializeFirebase() {
            try {
                // 1. Firebase App ko initialize karein
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. Authentication shuru karein
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userId = user.uid;
                        console.log("User signed in:", userId);
                        setupFirestoreListener(userId);
                    } else {
                        console.log("User signed in anonymously.");
                        // Agar auth fail ho to bhi listener chalao (public data ke liye)
                        setupFirestoreListener(null); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingIndicator.textContent = ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: Firebase ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§;
            }
        }
        
        // Firestore se data sunne aur UI ko update karne ka function
        function setupFirestoreListener(userId) {
            const configPath = doc(db, 'config', 'main');
            
            onSnapshot(configPath, async (docSnap) => {
                if (docSnap.exists()) {
                    // Data fields are case-sensitive, using the names as per user's final entry
                    const data = docSnap.data();

                    const mainVideoId = getEmbedId(data.youtubeUrl);
                    const adVideoId = getEmbedId(data.adyoutubeUrl); // Use adyoutubeUrl
                    
                    // Note: Watch time field was 'watch time' and is now corrected in code logic
                    const timeKey = data.requiredWatchTime ? 'requiredWatchTime' : 'watch time';
                    requiredWatchTime = data[timeKey] || 5; 
                    adBodyText = data.adBody || data.adbody || "Voice Ad is ready!"; // Use adBody/adbody

                    // Spark UI update
                    sparkText.textContent = 0s / ${requiredWatchTime}s - Ad Dekhiye;
                    
                    // TTS data fetch karein
                    ttsData = await fetchTTS(adBodyText);

                    // Players create karein agar abhi tak nahi hue hain
                    if (!mainPlayer) {
                        createPlayers(mainVideoId, adVideoId);
                    } else {
                        // Agar player pehle se hain to sirf video badlein
                        mainPlayer.loadVideoById(mainVideoId);
                        adPlayer.loadVideoById(adVideoId);
                        
                        // Reset ad status
                        isAdSparked = false;
                        currentWatchTime = 0;
                        sparkButton.classList.remove('ready', 'bg-green-700');
                        sparkButton.classList.add('bg-red-600', 'spark-button');
                        adVideoContainer.classList.add('hidden'); // PiP ko chhupayein
                        startAdTimer();
                    }

                    // UI ko dikhayein
                    loadingIndicator.classList.add('hidden');
                    phoneFrame.classList.remove('hidden');
                } else {
                    console.warn("Document 'config/main' not found. Displaying default video.");
                    // Default video chalaein agar data nahi milta
                    if (!mainPlayer) {
                         createPlayers('5s_DqJ83X5g', 'wz8S9fH4L20');
                    }
                    loadingIndicator.classList.add('hidden');
                    phoneFrame.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                loadingIndicator.textContent = ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ (${error.message});
            });
        }
        
        // App ko shuru karein
        window.onload = initializeFirebase;

    </script>
</body>
</html>
